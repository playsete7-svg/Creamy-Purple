<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cardápio Real – Sistema com Autenticação e FIREBASE</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --primary:#800080;
    --muted:#7d8590;
    --bg:#f5f6f7;
    --card:#ffffff;
    --radius:12px;
    font-family:Inter, "Helvetica Neue", Arial, sans-serif;
    color:#222;
  }
  *{box-sizing:border-box}
  /* Ajuste de padding padrão */
  body{margin:0;background:var(--bg);padding:18px;display:flex;justify-content:center}
  .app{width:100%;max-width:1200px}
  header.banner{
    background:linear-gradient(90deg,var(--primary),#ff6b6b);
    color:#fff;border-radius:12px;padding:18px;display:flex;align-items:center;gap:16px;margin-bottom:14px;
  }
  header.banner img.logo{width:72px;height:72px;border-radius:50%;object-fit:cover;background:#fff;}
  header .meta h1{margin:0;font-size:20px}
  header .meta p{margin:6px 0 0;color:rgba(255,255,255,0.95);font-size:13px}
  .controls{display:flex;gap:12px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
  .search{flex:1;display:flex;align-items:center;background:#fff;padding:8px;border-radius:10px}
  .search input{border:0;outline:0;width:100%;font-size:15px}
  .grid{display:grid;grid-template-columns:260px 1fr 360px;gap:14px}
  
  /* --- INÍCIO: AJUSTES DE RESPONSIVIDADE (MOBILE) --- */
  
  /* Esconde o user-badge que está no footer em telas grandes (desktop) */
  .user-badge.only-mobile {
      display: none;
  }

  /* Ajuste para telas menores que 1024px (tablets e celular) */
  @media (max-width:1024px){ 
    .grid{grid-template-columns:1fr; } 
    
    /* Torna o painel do carrinho responsivo e centralizado */
    .cart-panel{
      position:fixed;
      bottom:90px; /* 90px de distância do rodapé fixo */
      width:min(90%, 320px); 
      left: 50%; 
      transform: translateX(-50%);
      right: auto; 
      z-index:60;
    }

    /* Esconde o status do rodapé para dar espaço aos botões */
    #footerStatus {
        display: none; 
    }

    /* Mostra o user-badge do footer em mobile, ao lado do botão do carrinho */
    .user-badge.only-mobile {
        display: flex; /* Agora visível em mobile */
        margin-right: 10px; /* Adiciona um pequeno espaçamento do botão ao lado */
    }

    /* Reduz o tamanho do botão no footer para caber melhor */
    .footer-content-wrapper .btn {
      padding: 8px 10px;
      font-size: 14px;
    }
  }

  /* Ajuste para telas muito pequenas (celulares estreitos) */
  @media (max-width:600px){
    body{padding: 10px;} 
    header.banner{padding: 12px;} 
    header.banner img.logo{width: 60px; height: 60px;} 
    .controls{gap: 8px;} 
  }

  /* Ajuste para o rodapé fixo */
  .footer-fixed{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      background:#fff;
      border-top:1px solid #eee;
      padding:10px; 
      display:flex;
      justify-content:center;
      z-index:90;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05); 
  }
  
  /* Novo wrapper para alinhar o conteúdo do rodapé com o max-width do app */
  .footer-content-wrapper {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      max-width: 1200px;
      padding: 0 8px; 
  }
  /* --- FIM: AJUSTES DE RESPONSIVIDADE (MOBILE) --- */

  .side{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
  main {
      overflow-y: auto;
      min-height: 0; 
  }
  .items{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding-bottom: 30px; 
  }
  .categories button{display:block;width:100%;text-align:left;padding:10px;border-radius:8px;border:0;background:transparent;margin-bottom:8px;cursor:pointer}
  .categories button.active{background:#fff7f7;color:var(--primary);font-weight:700}
  .item{display:flex;gap:12px;align-items:flex-start;background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 14px rgba(0,0,0,0.04)}
  .item img{width:110px;height:90px;object-fit:cover;border-radius:10px}
  .item .info h3{margin:0;display:flex;justify-content:space-between;align-items:center;gap:12px}
  .item .info p{margin:6px 0 10px;color:var(--muted)}
  .actions{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
  .btn{background:var(--primary);color:#fff;padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .pill{background:#fff;padding:6px 10px;border-radius:10px;border:1px solid #eee;cursor:pointer}
  .qty{display:flex;gap:6px;align-items:center;background:#fff;padding:6px;border-radius:8px}
  .qty button{border:0;background:transparent;font-size:18px;cursor:pointer}
  .modal{position:fixed;left:0;top:0;right:0;bottom:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:80;padding:12px}
  .modal.open{display:flex}
  .modal .card{background:#fff;border-radius:12px;padding:16px;width:100%;max-width:1000px;max-height:85vh;overflow:auto}
  .addon-group{border:1px solid #f1f1f1;padding:12px;border-radius:8px;margin-bottom:12px}
  .addon-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .addon-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-top:1px solid #fbfbfb}
  .addon-controls{display:flex;gap:8px;align-items:center}
  .addon-controls button{background:#fff;border:1px solid #eee;border-radius:6px;padding:6px 10px;cursor:pointer}
  .addon-controls .count{min-width:28px;text-align:center;display:inline-block}
  .cart-panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.08)}
  .admin-bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .meta-addon-info{font-size:12px;color:var(--muted);margin-top:4px}
  .hidden{display:none}
  .auth-tabs{display:flex;gap:8px;margin-bottom:16px}
  .auth-tabs button{flex:1;padding:10px;border:0;background:#f5f5f5;border-radius:8px;cursor:pointer;font-weight:600}
  .auth-tabs button.active{background:var(--primary);color:#fff}
  .admin-tabs{display:flex;gap:8px;margin-bottom:16px;border-bottom:1px solid #eee;padding-bottom:8px;overflow-x:auto;}
  .admin-tabs button{flex-shrink:0;padding:10px 15px;border:0;background:#f5f5f5;border-radius:8px;cursor:pointer;font-weight:600;}
  .admin-tabs button.active{background:var(--primary);color:#fff;}
  .admin-panel{padding-top:10px;}
  
  /* CORREÇÃO DO GRÁFICO: Define altura para o contêiner */
  #salesPanel { 
      height: 400px; 
      padding-bottom: 20px; 
  } 
  #salesChart { 
      width: 100%; 
      height: 100%; 
  }

  .form-group{margin-bottom:14px}
  .form-group label{display:block;margin-bottom:6px;font-weight:600;font-size:14px}
  .form-group input, .form-group select, .form-group textarea{width:100%;padding:10px;border:1px solid #e1e1e1;border-radius:8px;font-size:14px}
  .user-badge{background:#fff;padding:6px 12px;border-radius:20px;display:flex;align-items:center;gap:8px;cursor:pointer}
  .user-badge:hover{background:#f9f9f9}
  .item-management-note { background: #fff7e6; padding: 10px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #ff9800; }
  .addon-group-settings { margin-bottom: 15px; padding: 10px; border: 1px solid #e9ecef; border-radius: 6px; background: #f8f9fa; }
  .addon-item-row { display: flex; gap: 8px; align-items: center; margin-bottom: 6px; }
  .addon-item-row input { flex: 1; }
  .delivery-area-row { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; padding: 8px; border: 1px solid #eee; border-radius: 6px; }
  .delivery-area-row input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
  .delivery-area-row .area-name-input { flex: 2; }
  .delivery-area-row .area-fee-input { flex: 1; max-width: 100px; }
</style>
</head>
<body>
  <div class="app" id="app">
    <header class="banner">
      <img class="logo" id="logo" src="" alt="Logo">
      <div class="meta">
        <h1 id="name">Creamy Purple</h1>
        <p id="addr">R ALCIDES RODRIGUES PONTES • <span id="status">Aberto até as 23:00</span></p>
      </div>
      <div style="margin-left:auto;text-align:right">
      </div>
      </header>

    <div class="controls">
      <div class="search"><input id="q" placeholder="Buscar no cardápio — ex: calabresa, bacon..." /></div>
      <div id="adminControls" class="hidden">
        <button class="pill" id="btnAdminPanel">Painel Admin</button>
        <button class="pill" id="btnExport">Exportar JSON</button>
        <button class="pill" id="btnImport">Importar JSON</button>
        <input id="fileImport" type="file" accept=".json" style="display:none" />
      </div>
      <div style="margin-left:auto" class="admin-bar" id="adminBar">
        <button class="pill" id="btnReset" style="background:#dc3545; color:white;">Reset demo (Firebase)</button>
      </div>
    </div>

    <div class="grid">
      <aside class="side">
        <h4>Categorias</h4>
        <div class="categories" id="cats"></div>
      </aside>

      <main>
        <div id="items" class="items"></div>

        <div class="modal" id="adminModal">
          <div class="card" role="dialog" aria-modal="true" style="max-width:1000px">
            <h3>Painel de Administração</h3>
            <div class="admin-tabs">
              <button id="tabOrders" class="active">Pedidos em Tempo Real</button>
              <button id="tabSales">Relatório de Vendas</button>
              <button id="tabCustomers">Controle de Clientes</button>
              <button id="tabSettings">Configurações da Loja</button>
            </div>

            <div id="adminContent">
              <div id="ordersPanel" class="admin-panel">
                <h4>Pedidos Atuais</h4>
                <div id="currentOrdersList"></div>
              </div>
              <div id="salesPanel" class="admin-panel hidden">
                <h4>Relatório Gráfico de Vendas</h4>
                <canvas id="salesChart"></canvas>
              </div>
              <div id="customersPanel" class="admin-panel hidden">
                <h4>Controle de Clientes</h4>
                <div id="customersList"></div>
              </div>
              <div id="settingsPanel" class="admin-panel hidden">
                <h4>Configurações da Loja</h4>
                <form id="storeSettingsForm">
                  <div class="form-group">
                    <label for="restaurantName">Nome da Loja</label>
                    <input type="text" id="restaurantName" required>
                  </div>
                  <div class="form-group">
                    <label for="restaurantAddress">Endereço</label>
                    <input type="text" id="restaurantAddress" required>
                  </div>
                  <div class="form-group" id="savedAddressesGroup" style="display:none;">
                    <label for="savedAddresses">Endereços Salvos</label>
                    <select id="savedAddresses" class="form-control">
                      <option value="">Selecionar um endereço salvo...</option>
                      <option value="Casa">Casa (Rua Exemplo, 123, Cidade)</option>
                      <option value="Trabalho">Trabalho (Av. Principal, 456, Cidade)</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="restaurantStatus">Status (Horário de Funcionamento)</label>
                    <input type="text" id="restaurantStatus" placeholder="Ex: Aberto até as 23:00" required>
                  </div>
                  
                  <div class="form-group">
                    <label for="restaurantLogoFile">Logo da Loja (Escolha Arquivo)</label>
                    <input type="file" id="restaurantLogoFile" accept="image/*">
                    <div style="margin-top:10px;"><img id="currentLogoPreview" src="" alt="Prévia do Logo" style="max-width:100px; height:auto; border-radius:8px;"></div>
                    <input type="hidden" id="restaurantLogoUrl"> </div>
                  <h5 style="margin-top:20px;">Taxas de Entrega por Área</h5>
                  <div id="deliveryAreasList">
                    </div>
                  <button type="button" class="pill" id="btnAddDeliveryArea" style="background:#e6ffe6; color:#28a745; margin-bottom:10px;">+ Adicionar Área de Entrega</button>
                  <div style="text-align:right;margin-top:16px">
                    <button type="submit" class="btn">Salvar Configurações</button>
                  </div>
                </form>
              </div>
            </div>

            <div style="text-align:right;margin-top:16px">
              <button id="closeAdminModal" class="btn">Fechar</button>
            </div>
          </div>
        </div>

      </main>

      <aside class="side cart-panel" id="cartPanel">
        <h4>Carrinho</h4>
        <div id="cartList"></div>
        <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Subtotal</div>
            <div id="subtotal" style="font-weight:800">R$ 0,00</div>
          </div>
          <div>
            <button id="btnCheckout" class="btn">Finalizar</button>
          </div>
        </div>
      </aside>
    </div>

    <div class="modal" id="itemDetailsModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:500px">
        <h3 id="itemDetailsModalTitle">Adicionar Novo Item</h3>
        <form id="itemDetailsForm">
          <input type="hidden" id="itemIdDetails" />
          <div class="form-group">
            <label for="itemName">Nome do Item</label>
            <input type="text" id="itemName" required>
          </div>
          <div class="form-group">
            <label for="itemDesc">Descrição</label>
            <textarea id="itemDesc" rows="3" required></textarea>
          </div>
          <div class="form-group">
            <label for="itemPrice">Preço (R$)</label>
            <input type="number" id="itemPrice" step="0.01" required>
          </div>
          <div class="form-group">
            <label for="itemCategory">Categoria</label>
            <select id="itemCategory" required></select>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
            <button type="button" id="itemDetailsCancel" class="pill">Cancelar</button>
            <button type="submit" class="btn" id="itemDetailsSubmit">Salvar Detalhes</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal" id="addonManagementModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:800px">
        <h3 id="addonManagementTitle">Gerenciar Adicionais para <span id="addonItemName" style="color:var(--primary);"></span></h3>
        
        <div id="addonGroupsList"></div>
        
        <div style="margin-top:16px; display:flex; justify-content:space-between; align-items:center;">
          <button type="button" class="btn" id="btnAddAddonGroup" style="background:#28a745;">+ Adicionar Grupo</button>
          <div>
            <button type="button" id="addonManagementCancel" class="pill">Cancelar</button>
            <button type="button" class="btn" id="addonManagementSubmit">Salvar Adicionais</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="imageEditModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:500px">
        <h3 id="imageEditModalTitle">Editar Imagem para <span id="imageItemName" style="color:var(--primary);"></span></h3>
        <form id="imageEditForm">
          <input type="hidden" id="itemIdImage" />
          
          <div class="form-group">
            <label for="itemImgFile">Escolher Imagem do Item</label>
            <input type="file" id="itemImgFile" accept="image/*">
            <input type="hidden" id="itemImgUrl"> </div>
          <div style="text-align:center; margin-bottom:16px;">
             <img id="currentImagePreview" src="" alt="Prévia" style="max-width:100%; height:auto; border-radius:8px; margin-top:10px;">
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
            <button type="button" id="imageEditCancel" class="pill">Cancelar</button>
            <button type="submit" class="btn" id="imageEditSubmit">Salvar Imagem</button>
          </div>
        </form>
      </div>
    </div>


    <div class="modal" id="modal">
      <div class="card" role="dialog" aria-modal="true">
        <h3 id="modalTitle">Adicionais</h3>
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
          <div><strong id="modalItemName"></strong></div>
          <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
            <div class="small">Quantidade do item:</div>
            <div class="qty" id="itemQtyControls">
              <button data-action="decrement-qty">-</button>
              <span id="modalItemQty">1</span>
              <button data-action="increment-qty">+</button>
            </div>
          </div>
        </div>
        <div id="modalAddons"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
          <div class="small">Total do item: <strong id="modalTotal">R$ 0,00</strong></div>
          <div>
            <button id="modalCancel" class="pill">Cancelar</button>
            <button id="modalConfirm" class="btn">Adicionar ao carrinho</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="authModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:420px">
        <h3 id="authTitle">Entrar / Cadastrar</h3>
        <div class="auth-tabs">
          <button id="tabLogin" class="active">Entrar</button>
          <button id="tabRegister">Cadastrar</button>
        </div>
        
        <div id="loginForm">
          <div class="form-group">
            <label>Email ou usuário</label>
            <input type="text" id="loginUser" placeholder="seu@email.com">
          </div>
          <div class="form-group">
            <label>Senha</label>
            <input type="password" id="loginPass" placeholder="••••••">
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
            <button id="loginCancel" class="pill">Cancelar</button>
            <button id="loginSubmit" class="btn">Entrar</button>
          </div>
        </div>

        <div id="registerForm" class="hidden">
          <div class="form-group">
            <label>Nome completo</label>
            <input type="text" id="regName" placeholder="João Silva">
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="regEmail" placeholder="seu@email.com">
          </div>
          <div class="form-group">
            <label>Telefone</label>
            <input type="tel" id="regPhone" placeholder="(11) 99999-9999">
          </div>
          <div class="form-group">
            <label>Senha</label>
            <input type="password" id="regPass" placeholder="••••••">
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
            <button id="registerCancel" class="pill">Cancelar</button>
            <button id="registerSubmit" class="btn">Cadastrar</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="profileModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:600px">
        <h3>Meu Perfil</h3>
        <div style="background:#f9f9f9;padding:12px;border-radius:8px;margin-bottom:16px">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px">
            <strong id="profileName"></strong>
            <button class="pill" id="logoutBtn">Sair</button>
          </div>
          <div class="small" id="profileEmail"></div>
          <div class="small" id="profilePhone"></div>

          <h4 style="margin-top:20px;">Meus Endereços Salvos</h4>
          <div id="savedUserAddressesList">
            </div>
          <div class="form-group" style="margin-top:15px;">
            <label for="newAddressInput">Adicionar Novo Endereço</label>
            <input type="text" id="newAddressInput" placeholder="Ex: Rua Exemplo, 123 - Bairro - Cidade" />
          </div>
          <button type="button" class="btn" id="btnAddUserAddress" style="background:#28a745; margin-bottom:15px;">Salvar Endereço</button>

          <hr/>
        </div>
        
        <h4>Meus Pedidos</h4>
        <div id="profileOrders"></div>
        
        <div style="text-align:right;margin-top:16px">
          <button id="closeProfile" class="btn">Fechar</button>
        </div>
      </div>
    </div>

    <div class="modal" id="checkoutModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:600px">
        <h3>Finalizar Pedido</h3>
        
        <form id="checkoutForm"> 
            <div id="checkoutContent">
              <h4>Seus Dados</h4>
              <div class="form-group">
                <label for="checkoutName">Nome Completo</label>
                <input type="text" id="checkoutName" placeholder="Seu nome" required>
              </div>
              <div class="form-group">
                <label for="checkoutAddress">Endereço de Entrega</label>
                <input type="text" id="checkoutAddress" placeholder="Rua, número, bairro, complemento" required>
    <div class="form-group" id="checkoutSavedAddressesGroup" style="display:none; margin-top: 10px;">
      <label for="checkoutSavedAddresses">Ou selecione um endereço salvo:</label>
      <select id="checkoutSavedAddresses" class="form-control">
        <option value="" disabled selected>Selecione um endereço salvo...</option>
      </select>
    </div>
              </div>
              <div class="form-group">
                <label for="checkoutPhone">Telefone</label>
                <input type="tel" id="checkoutPhone" placeholder="(XX) XXXXX-XXXX" required>
              </div>
              
              <div class="form-group">
                  <label for="deliveryAreaSelect">Área de Entrega (Para cálculo da taxa)</label>
                  <select id="deliveryAreaSelect" required>
                      <option value="" disabled selected>Selecione sua área...</option>
                      </select>
              </div>
              <h4>Forma de Pagamento</h4>
              <div class="form-group">
                <label>Escolha uma opção:</label>
                <div>
                  <input type="radio" id="paymentCredit" name="paymentMethod" value="credit" checked>
                  <label for="paymentCredit">Cartão de Crédito</label>
                </div>
                <div>
                  <input type="radio" id="paymentDebit" name="paymentMethod" value="debit">
                  <label for="paymentDebit">Cartão de Débito</label>
                </div>
                <div>
                  <input type="radio" id="paymentCash" name="paymentMethod" value="cash">
                  <label for="paymentCash">Dinheiro</label>
                </div>
              </div>
              <div class="form-group" id="cashChangeGroup" style="display:none;">
                <label for="cashChange">Precisa de troco para quanto?</label>
                <input type="number" id="cashChange" placeholder="Ex: 50.00">
              </div>

              <h4>Resumo do Pedido</h4>
              <div id="checkoutCartSummary"></div>
              <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px;border-top:1px solid #eee;padding-top:8px;margin-top:8px;">
                <span>Subtotal:</span>
                <span id="checkoutSubtotal">R$ 0,00</span>
              </div>
              <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:8px;">
                <span>Taxa de Entrega (<span id="checkoutAreaName">N/A</span>):</span>
                <span id="checkoutDeliveryFee">R$ 0,00</span>
              </div>
              <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
                <div>
                  <div class="small">Total Geral</div>
                  <div id="checkoutTotal" style="font-weight:800; color:var(--primary);">R$ 0,00</div>
                </div>
              </div>

            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
              <button type="button" id="checkoutCancel" class="pill">Cancelar</button>
              <button type="submit" id="checkoutSubmit" class="btn" disabled>Confirmar Pedido</button>
            </div>
        </form>
        </div>
    </div>

    <div class="modal" id="confirmationModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:500px; text-align:center;">
        <h3 style="color:#28a745; margin-bottom: 0;">🎉 Pedido Confirmado!</h3>
        <h1 id="orderNumberDisplay" style="color:var(--primary); margin: 10px 0 20px; font-size: 32px;">#XXXXXXX</h1>

        <h4>Resumo do Pedido</h4>
        <div id="confirmationSummaryContent" style="text-align:left; border:1px solid #eee; padding: 12px; border-radius:8px;">
          </div>
        
        <p style="margin-top:20px; color:var(--muted); font-size:14px;">
            Acompanhe o status do pedido no Painel do Administrador (se for admin) ou no seu Perfil.
        </p>

        <div style="text-align:right;margin-top:16px">
          <button id="closeConfirmationModal" class="btn">Voltar ao Cardápio</button>
        </div>
      </div>
    </div>

    <div class="footer-fixed">
      <div class="footer-content-wrapper">
        <div class="user-badge only-mobile" id="userBadge">
          <span id="userIcon">👤</span>
          <span id="userName">Entrar</span>
        </div>

        <span id="footerStatus">Faça login para fazer pedidos</span>
        <button class="btn" id="btnViewCart">Ver Carrinho (<span id="cartCount">0</span>)</button>
      </div>
    </div>

  </div>

<script type="module">
// =========================================================================
// === CONFIGURAÇÃO DO FIREBASE (CHAVES INSERIDAS PELO GÊMINI) ===
// =========================================================================
const firebaseConfig = {
    apiKey: "AIzaSyBYxYq65hf2zwBTKrwuFAg5AmS5iM88aLU", 
    authDomain: "luk123-b1986.firebaseapp.com", 
    projectId: "luk123-b1986", 
    storageBucket: "luk123-b1986.firebasestorage.app", 
    messagingSenderId: "55447377903", 
    appId: "1:55447377903:web:e9cbbcdba3a4ed5dc4081a"
};
// =========================================================================

// === INICIALIZAÇÃO DO FIREBASE E SDKs NECESSÁRIOS ===
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
import { 
    getFirestore, collection, doc, getDoc, setDoc, updateDoc, 
    addDoc, query, orderBy, onSnapshot 
} from "https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
// Documento único para o cardápio e configurações da loja
const menuDocRef = doc(db, "config", "cardapioData"); 
// Coleção para pedidos, permitindo queries e tempo real
const ordersCollectionRef = collection(db, "orders"); 
// Coleção para usuários (opcional, mantendo o local storage para a demo)
const usersCollectionRef = collection(db, "users");

// Variáveis globais
let DATA = null; 
let orders = []; 
let users = []; 

const CART_KEY = "cardapio_cart_v1";
const ORDERS_KEY = "cardapio_orders_v1";

const ORDER_STATUSES = {
  pending: { label: 'Pendente', color: '#ffc107' },
  preparing: { label: 'Em Preparo', color: '#17a2b8' },
  ready: { label: 'Pronto para Entrega', color: '#28a745' },
  delivered: { label: 'Entregue', color: '#6c757d' },
  cancelled: { label: 'Cancelado', color: '#dc3545' }
};

const ADMIN_CREDENTIALS = {
  user: "admin",
  pass: "admin123"
};

let activeCat = null;
let cart = loadCart();
let modalState = null;
let itemState = null;
let addonManagerState = null;
let currentUser = null;
let isAdmin = false;
let salesChartInstance = null;
let lastPendingCount = 0; // Para notificação


const $ = sel => document.querySelector(sel);
const formatBRL = v => "R$ " + (v || 0).toFixed(2).replace(".",",");

// Funções de Storage (Mantidas para Carrinho e Login SIMPLIFICADO de Cliente)
function loadCart(){ try{ return JSON.parse(localStorage.getItem(CART_KEY)) || []; }catch(e){ return []; } }
function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }
function loadUsers(){ try{ return JSON.parse(localStorage.getItem("cardapio_users_v1")) || []; }catch(e){ return []; } }
function saveUsers(){ localStorage.setItem("cardapio_users_v1", JSON.stringify(users)); }

// =========================================================================
// === FUNÇÕES DE PERSISTÊNCIA (FIREBASE) ===
// =========================================================================

/**
 * Carrega o cardápio do Firestore (config/cardapioData).
 */
async function fetchMenuData() {
    try {
        // 1. Carrega o Cardápio
        const menuSnap = await getDoc(menuDocRef);
        if (menuSnap.exists()) {
            DATA = menuSnap.data();
            console.log("Cardápio carregado do Firebase.");
        } else {
            console.warn("Nenhum dado de cardápio encontrado no Firebase. Usando Demo e salvando.");
            DATA = loadDemoData();
            // Salva a demo no Firebase para começar a persistência
            await setDoc(menuDocRef, DATA);
        }

        // Inicializa a primeira categoria ativa
        if (DATA.categories.length > 0) {
            activeCat = DATA.categories[0].id;
        }

        renderAll();
        // Começa a monitorar pedidos em tempo real imediatamente (ou após login)
        setupRealtimeOrdersListener(); 

        return true;
    } catch (e) {
        console.error("Erro ao carregar cardápio do Firebase:", e);
        alert("Erro ao conectar com o banco de dados. Carregando dados de demonstração local.");
        DATA = loadDemoData();
        renderAll();
        return false;
    }
}


/**
 * Salva o cardápio (DATA) de volta para o Firestore.
 */
async function saveMenuData() {
    if (!isAdmin) {
        alert("Acesso negado. Apenas administradores podem salvar.");
        return false;
    }
    try {
        await setDoc(menuDocRef, DATA);
        console.log("Dados do cardápio salvos no Firebase com sucesso!");
        return true;
    } catch (e) {
        console.error("Erro ao salvar cardápio no Firebase:", e);
        alert("Falha ao salvar. Verifique as regras de segurança do seu Firebase.");
        return false;
    }
}

/**
 * Mantém o array 'orders' atualizado em tempo real e notifica o admin.
 */
function setupRealtimeOrdersListener() {
    // Busca todos os pedidos, ordenados pelo mais recente
    const q = query(ordersCollectionRef, orderBy("createdAt", "desc"));

    // onSnapshot: mantém a conexão aberta para updates em tempo real
    onSnapshot(q, (snapshot) => {
        const newOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Verifica se há novos pedidos pendentes APENAS se for Admin
        if (isAdmin) {
            const currentPending = newOrders.filter(o => o.status === "pending").length;
            if (currentPending > lastPendingCount) {
              notifyNewOrder();
            }
            lastPendingCount = currentPending;
        }

        orders = newOrders;
        
        // Atualiza as visualizações se estiverem abertas
        if ($("#adminModal").classList.contains('open')) {
            renderAdminOrders();
            renderAdminDashboard();
        }
        if ($("#profileModal").classList.contains('open')) {
            renderProfileOrders();
        }
    }, (error) => {
        console.error("Erro no listener de pedidos:", error);
    });
}


/**
 * Atualiza o status de um pedido no Firestore.
 * AGORA EXPOSTA GLOBALMENTE para uso no onchange do HTML
 */
async function updateOrderStatus(orderId, newStatus) {
  if (!isAdmin) return;
  
  try {
    const orderDocRef = doc(db, "orders", orderId);
    await updateDoc(orderDocRef, { status: newStatus });
    // O onSnapshot se encarregará de re-renderizar a lista automaticamente
  } catch (e) {
      console.error("Erro ao atualizar status no Firebase:", e);
      alert("Falha ao atualizar o status do pedido.");
  }
}

// =========================================================================
// === FUNÇÕES DE AUTENTICAÇÃO E ADMIN (SIMPLIFICADAS E ADAPTADAS) ===
// =========================================================================

function doLogin(){
    const user = $("#loginUser").value.trim();
    const pass = $("#loginPass").value;
    
    if(!user || !pass){ alert("Preencha todos os campos"); return; }
    
    // Simulação de Login de Admin
    if(user === ADMIN_CREDENTIALS.user && pass === ADMIN_CREDENTIALS.pass){ 
        currentUser = { id: "admin", name: "Administrador", email: "admin@sistema.com", isAdmin: true, savedAddresses: [] };
        isAdmin = true;
        closeAuthModal();
        updateUserBadge();
        toggleAdminUI();
        renderCategories();
        renderItems();
        // setupRealtimeOrdersListener já está ativo e começa a notificar
        alert("Bem-vindo, Admin! Painel em Tempo Real (via Firebase) ativado. 🎉");
        return;
    }

    // SIMULAÇÃO DE LOGIN DE CLIENTE (usa array local 'users')
    const foundUser = users.find(u => (u.email === user || u.email === user) && u.password === pass);
    if(foundUser){
        currentUser = { id: foundUser.id, name: foundUser.name, email: foundUser.email, phone: foundUser.phone, isAdmin: false, savedAddresses: foundUser.savedAddresses || [] };
        isAdmin = false;
        closeAuthModal();
        updateUserBadge();
        toggleAdminUI();
        renderCategories();
        renderItems();
        alert(`Bem-vindo de volta, ${foundUser.name.split(" ")[0]}! (Conta Simples) 😊`);
        return;
    }
    
    alert("Credenciais inválidas. Para Admin use: admin/admin123");
}

function doRegister(){
    const name = $("#regName").value.trim();
    const email = $("#regEmail").value.trim();
    const phone = $("#regPhone").value.trim();
    const pass = $("#regPass").value;
    
    if(!name || !email || !pass){ alert("Preencha nome, email e senha"); return; }
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if(!emailRegex.test(email)){ alert("Email inválido"); return; }
    if(pass.length < 4){ alert("Senha deve ter pelo menos 4 caracteres"); return; }
    if(users.find(u => u.email === email)){ alert("Email já cadastrado"); return; }
    
    const newUser = { id: Date.now().toString(), name, email, phone, password: pass, createdAt: new Date().toISOString(), savedAddresses: [] };
    
    users.push(newUser);
    saveUsers(); // Salva no localStorage (para a demo)
    
    currentUser = { id: newUser.id, name: newUser.name, email: newUser.email, phone: newUser.phone, isAdmin: false, savedAddresses: [] };
    closeAuthModal();
    updateUserBadge();
    alert(`Cadastro realizado! Bem-vindo, ${name.split(" ")[0]}! 🎉`);
}


// =========================================================================
// === FUNÇÃO DE PEDIDO (AGORA PERSISTENTE FIREBASE) ===
// =========================================================================

async function finalizeOrder(e) {
  e.preventDefault();
  
  if (!currentUser) {
      alert("Você precisa estar logado para fazer o pedido.");
      return;
  }
  
  const selectedOption = $("#deliveryAreaSelect").options[$("#deliveryAreaSelect").selectedIndex];
  if (!selectedOption || selectedOption.value === "") {
      alert("Por favor, selecione sua Área de Entrega para calcular a taxa.");
      return;
  }

  const deliveryFee = parseFloat(selectedOption.dataset.fee);
  const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
  const total = subtotal + deliveryFee;
  
  const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
  let changeNeeded = 0;

  if (paymentMethod === 'cash') {
    changeNeeded = parseFloat($("#cashChange").value) || 0;
    if (changeNeeded > 0 && changeNeeded < total) {
      alert("O valor do troco deve ser maior ou igual ao total do pedido.");
      return;
    }
  }

  const newOrder = {
    userId: currentUser.id,
    userName: $("#checkoutName").value.trim(),
    userPhone: $("#checkoutPhone").value.trim(),
    address: $("#checkoutAddress").value.trim(),
    deliveryAreaId: $("#deliveryAreaSelect").value,
    deliveryAreaName: selectedOption.textContent.split('(')[0].trim(),
    deliveryFee: deliveryFee,
    items: cart.map(item => ({ 
        name: item.name,
        qty: item.qty || 1, 
        totalPrice: item.totalPrice,
        // Garante que o objeto de addon seja simples para o banco
        addons: item.addons.flatMap(group => group.selected)
            .map(addon => {
                const originalItem = getItem(item.itemId);
                const originalGroup = originalItem.addonGroups.find(g => g.id === addon.groupId);
                const originalAddon = originalGroup.addons.find(a => a.id === addon.addonId);
                return { 
                    name: originalAddon.name, 
                    qty: addon.qty, 
                    price: originalAddon.price 
                };
            }) 
    })), 
    subtotal: subtotal,
    total: total,
    paymentMethod: paymentMethod,
    changeNeeded: changeNeeded,
    status: 'pending',
    createdAt: new Date().toISOString()
  };
  
  // Envio do pedido para o Firebase (banco de dados real!)
  try {
      const docRef = await addDoc(ordersCollectionRef, newOrder);
      cart = []; // Clear cart
      saveCart();
      closeCheckoutModal();
      renderCart();
      showConfirmationModal({ ...newOrder, id: docRef.id });
  } catch (e) {
      console.error("Falha ao salvar pedido no Firebase:", e);
      alert("Falha ao finalizar pedido. Verifique sua conexão ou as regras do Firebase.");
  }
}

// =========================================================================
// === FUNÇÕES DE DEMONSTRAÇÃO E MANUTENÇÃO (Adaptadas para Firebase) ===
// =========================================================================
function loadDemoData(){
    return {
        restaurant:{
            name:"Creamy Purple (FIREBASE TEST)",
            address:"Rua Fictícia, 61",
            status:"Aberto até as 23:00",
            logo:blankSVG(),
            deliveryAreas: [
                { id: 'area1', name: 'Centro da Cidade', fee: 5.00 },
                { id: 'area2', name: 'Região Oeste', fee: 8.00 }
            ]
        },
        categories:[
            {id:"lanc", title:"LANÇAMENTOS"},
            {id:"trad", title:"Lanches Tradicionais"}
        ],
        items:[
            { 
                id:"cmb1", 
                category:"lanc", 
                name:"Combo Real-Time", 
                desc:"Este item está salvo no Firebase!", 
                price:57.00, 
                img:blankSVG(), 
                addonGroups:[
                    { 
                        id: 'g1', 
                        name: 'Escolha o Pão', 
                        max: 1, 
                        free: 0, 
                        required: true, 
                        addons: [
                            { id: 'a1', name: 'Pão Brioche', price: 0.00 },
                            { id: 'a2', name: 'Pão Australiano', price: 2.50 }
                        ]
                    },
                    { 
                        id: 'g2', 
                        name: 'Adicionar Molho', 
                        max: 3, 
                        free: 1, 
                        required: false, 
                        addons: [
                            { id: 'a3', name: 'Maionese da Casa', price: 1.00 },
                            { id: 'a4', name: 'Molho Barbecue', price: 1.00 },
                            { id: 'a5', name: 'Molho Picante', price: 1.50 }
                        ]
                    }
                ] 
            },
            { 
                id:"xcal", 
                category:"trad", 
                name:"X-Salada Firestore", 
                desc:"Este cardápio é persistente.", 
                price:24.00, 
                img:blankSVG(), 
                addonGroups:[] 
            }
        ]
    };
}

// Altera a função resetDemo para salvar a demo no Firebase
async function resetDemo(){
    if(confirm("Restaurar demo? Perderá alterações salvas no Firebase e reescreverá o cardápio no banco.")){
        DATA = loadDemoData();
        cart=[];
        saveCart();
        await saveMenuData(); // Salva a demo no Firebase
        renderAll();
    }
}

// === NOTIFICAÇÃO DO SISTEMA (Chamada pelo onSnapshot) ===
if (Notification.permission !== "granted") {
    Notification.requestPermission();
}
function notifyNewOrder() {
    if (Notification.permission === "granted") {
        new Notification("🛍️ Novo Pedido Recebido!", { 
            body: "Um novo pedido pendente chegou ao painel.",
            icon: "https://cdn-icons-png.flaticon.com/512/2331/2331970.png"
        });
    }
}

// =========================================================================
// === FUNÇÕES AUXILIARES (LÓGICA INALTERADA) ===
// =========================================================================
function blankSVG(){
    return "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'400\'><rect fill=\'#fff\' width=\'100%\' height=\'100%\'/><text x=\'50%\' y=\'50%\' dominant-baseline=\'middle\' text-anchor=\'middle\' font-size=\'28\' fill=\'#ff3b3b\' font-family=\'Arial\'>Logo</text></svg>`);
}

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}

function renderAll(){
    $("#name").textContent = DATA.restaurant.name;
    $("#addr").textContent = DATA.restaurant.address + " • " + DATA.restaurant.status;
    $("#logo").src = DATA.restaurant.logo || blankSVG();
    renderCategories();
    renderItems();
    renderCart();
    updateUserBadge();
    toggleAdminUI();
}

function updateUserBadge(){
    if(currentUser){
        // userBadge agora está apenas no footer e é sempre o mesmo elemento
        $("#userIcon").textContent = currentUser.isAdmin ? "⚙️" : "👤";
        $("#userName").textContent = currentUser.name.split(" ")[0];
        $("#footerStatus").textContent = currentUser.isAdmin ? "Modo Administrador ativo" : `Logado como ${currentUser.name.split(" ")[0]}`;
    } else {
        $("#userIcon").textContent = "👤";
        $("#userName").textContent = "Entrar";
        $("#footerStatus").textContent = "Faça login para fazer pedidos";
    }
}

function toggleAdminUI() {
    const adminControls = $("#adminControls");
    const adminBar = $("#adminBar");
    if (isAdmin) {
        adminControls.classList.remove("hidden");
        $("#btnReset").classList.remove("hidden"); // Mostrar o botão reset que salva no Firebase
    } else {
        adminControls.classList.add("hidden");
        $("#btnReset").classList.add("hidden");
    }
}

function openAuthModal(){
    $("#authModal").classList.add("open");
    showLoginForm();
}

function closeAuthModal(){
    $("#authModal").classList.remove("open");
    clearAuthForms();
}

function showLoginForm(){
    $("#tabLogin").classList.add("active");
    $("#tabRegister").classList.remove("active");
    $("#loginForm").classList.remove("hidden");
    $("#registerForm").classList.add("hidden");
}

function showRegisterForm(){
    $("#tabRegister").classList.add("active");
    $("#tabLogin").classList.remove("active");
    $("#registerForm").classList.remove("hidden");
    $("#loginForm").classList.add("hidden");
}

function clearAuthForms(){
    $("#loginUser").value = "";
    $("#loginPass").value = "";
    $("#regName").value = "";
    $("#regEmail").value = "";
    $("#regPhone").value = "";
    $("#regPass").value = "";
}

function openProfileModal(){
    if(!currentUser || currentUser.isAdmin){ 
        // Admin usa o Painel Admin
        openAdminModal('settings');
        return;
    }
    $("#profileName").textContent = currentUser.name;
    $("#profileEmail").textContent = currentUser.email;
    $("#profilePhone").textContent = currentUser.phone;
    renderProfileAddresses();
    renderProfileOrders();
    $("#profileModal").classList.add("open");
}

function closeProfileModal(){
    $("#profileModal").classList.remove("open");
}

function renderProfileAddresses() {
  const list = $("#savedUserAddressesList");
  list.innerHTML = '';
  if (!currentUser || !currentUser.savedAddresses || currentUser.savedAddresses.length === 0) {
    list.innerHTML = '<div class="small" style="color:var(--muted)">Nenhum endereço salvo.</div>';
    return;
  }
  
  currentUser.savedAddresses.forEach((address, index) => {
    const div = document.createElement('div');
    div.classList.add('delivery-area-row');
    div.style.padding = '6px';
    div.innerHTML = `
      <div style="flex:1;">${address}</div>
      <button type="button" class="pill" style="background:#dc3545; color:white; padding:4px 8px;" onclick="removeUserAddress(${index})">Remover</button>
    `;
    list.appendChild(div);
  });
}

function removeUserAddress(index) {
  if (currentUser && currentUser.savedAddresses) {
    currentUser.savedAddresses.splice(index, 1);
    const userToUpdate = users.find(u => u.id === currentUser.id);
    if (userToUpdate) {
        userToUpdate.savedAddresses = currentUser.savedAddresses;
        saveUsers();
        renderProfileAddresses();
        alert("Endereço removido.");
    }
  }
}

function renderProfileOrders() {
  const list = $("#profileOrders");
  list.innerHTML = '';
  
  const userOrders = orders.filter(o => o.userId === currentUser.id);

  if (userOrders.length === 0) {
    list.innerHTML = '<div class="small" style="color:var(--muted)">Nenhum pedido realizado.</div>';
    return;
  }
  
  userOrders.forEach(order => {
    const statusInfo = ORDER_STATUSES[order.status] || ORDER_STATUSES.pending;
    
    const div = document.createElement('div');
    div.style.cssText = 'border: 1px solid #eee; border-radius: 8px; padding: 12px; margin-bottom: 10px;';
    div.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong style="font-size:16px;">Pedido #${order.id.substring(0, 7)}</strong>
            <span style="font-weight:600; color:${statusInfo.color};">${statusInfo.label}</span>
        </div>
        <div class="small" style="color:var(--muted); margin: 4px 0;">Total: ${formatBRL(order.total)} • Em: ${new Date(order.createdAt).toLocaleDateString()}</div>
        <div style="font-size:12px; margin-top: 8px;">
            ${order.items.map(item => `${item.qty}x ${item.name}`).join('<br>')}
        </div>
    `;
    list.appendChild(div);
  });
}

function getItem(id){
    return DATA.items.find(i => i.id === id);
}

function getCategory(id){
    return DATA.categories.find(c => c.id === id);
}

function editCategory(id) {
    const cat = DATA.categories.find(c => c.id === id);
    if (!cat) return;
    const newTitle = prompt(`Novo nome para \"${cat.title}\":`, cat.title);
    if (newTitle && newTitle !== cat.title) {
        cat.title = newTitle;
        saveMenuData();
        renderCategories();
    }
}

async function removeCategory(id) {
    if (confirm("Ao remover a categoria, todos os itens associados a ela serão perdidos. Tem certeza?")) {
        DATA.categories = DATA.categories.filter(c => c.id !== id);
        DATA.items = DATA.items.filter(i => i.category !== id);
        activeCat = DATA.categories.length > 0 ? DATA.categories[0].id : null;
        await saveMenuData();
        renderCategories();
        renderItems();
    }
}

function renderCategories(){
    const catsEl = $("#cats");
    catsEl.innerHTML = '';
    
    DATA.categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.textContent = cat.title;
        btn.dataset.id = cat.id;
        if(cat.id === activeCat) btn.classList.add('active');
        btn.addEventListener("click", () => { activeCat = cat.id; renderCategories(); renderItems(); });

        if (isAdmin) {
          const container = document.createElement("div");
          container.style.display = 'flex'; container.style.alignItems = 'center'; container.style.gap = '4px'; container.style.marginBottom = '8px';
          btn.style.flexGrow = '1'; btn.style.margin = '0'; container.appendChild(btn);
          const editBtn = document.createElement("button");
          editBtn.textContent = '✏️'; editBtn.classList.add('pill'); 
          editBtn.style.cssText = 'padding: 6px 8px; font-size: 14px; margin: 0;';
          editBtn.addEventListener('click', (e) => { e.stopPropagation(); editCategory(cat.id); }); 
          container.appendChild(editBtn);
          const removeBtn = document.createElement("button");
          removeBtn.textContent = '❌'; removeBtn.classList.add('pill'); 
          removeBtn.style.cssText = 'padding: 6px 8px; font-size: 14px; margin: 0;';
          removeBtn.addEventListener('click', (e) => { e.stopPropagation(); removeCategory(cat.id); }); 
          container.appendChild(removeBtn);
          catsEl.appendChild(container);
        } else {
          catsEl.appendChild(btn);
        }
    });
    
    if (isAdmin) {
        // Botão para adicionar nova categoria (Admin) - Implementação simplificada
        const btnAdd = document.createElement('button');
        btnAdd.textContent = '+ Adicionar Categoria';
        btnAdd.style.cssText = 'background:#e6ffe6; color:#28a745; font-weight:700; border: 1px dashed #28a745; margin-top: 10px;';
        btnAdd.addEventListener('click', () => {
            const title = prompt("Qual o nome da nova categoria?");
            if(title){
                const newCat = { id: title.toLowerCase().replace(/\s/g, '_'), title };
                if(DATA.categories.find(c => c.id === newCat.id)){ 
                    alert("Uma categoria com nome similar já existe. Tente outro nome."); 
                    return;
                } 
                DATA.categories.push(newCat);
                saveMenuData();
                activeCat = newCat.id;
                renderCategories();
                renderItems();
            }
        });
        catsEl.appendChild(btnAdd);
    }
}

function renderItems(){
    const itemsEl = $("#items");
    itemsEl.innerHTML = '';
    
    const items = DATA.items.filter(i => i.category === activeCat);
    
    if (isAdmin) {
      // Adicionar botão para novo item no topo da lista
      const btnNew = document.createElement('button');
      btnNew.classList.add('btn');
      btnNew.style.cssText = 'background:#28a745; margin-bottom: 12px;';
      btnNew.textContent = '+ Adicionar Novo Item';
      btnNew.addEventListener('click', () => openItemDetailsModal());
      itemsEl.appendChild(btnNew);
    }
    
    if(items.length === 0){
        itemsEl.innerHTML += '<div class="small" style="color:var(--muted); text-align:center;">Nenhum item nesta categoria.</div>';
        return;
    }
    
    items.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.classList.add('item');
        itemEl.innerHTML = `
            <img src="${item.img || blankSVG()}" alt="${item.name}">
            <div class="info" style="flex:1;">
                <h3>
                    <span>${item.name}</span>
                    <span style="color:var(--primary); font-weight:800">${formatBRL(item.price)}</span>
                </h3>
                <p>${item.desc}</p>
                <div class="actions">
                    ${isAdmin ? `
                        <div style="display:flex;gap:8px;">
                            <button class="pill" data-id="${item.id}" data-action="manage-addons">Adicionais</button>
                            <button class="pill" data-id="${item.id}" data-action="edit-image">Imagem</button>
                            <button class="pill" data-id="${item.id}" data-action="edit-item">Editar</button>
                            <button class="pill" data-id="${item.id}" data-action="delete-item" style="background:#dc3545; color:white;">Deletar</button>
                        </div>
                    ` : ''}
                    <button class="btn" data-id="${item.id}" data-action="add-to-cart">${item.addonGroups.length > 0 ? 'Ver Opções' : 'Adicionar'}</button>
                </div>
            </div>
        `;
        itemsEl.appendChild(itemEl);
    });
    
    // Adicionar listeners para botões de item
    itemsEl.querySelectorAll('[data-action]').forEach(btn => {
        btn.addEventListener('click', (e) => handleItemAction(e.target.dataset.action, e.target.dataset.id));
    });
}

function handleItemAction(action, itemId){
    const item = getItem(itemId);
    if (!item) return;
    
    switch(action){
        case 'add-to-cart':
            if (item.addonGroups.length > 0) {
                openModal(item);
            } else {
                addItemToCart(item, 1, []);
            }
            break;
        case 'edit-item':
            openItemDetailsModal(item);
            break;
        case 'edit-image':
            openImageEditModal(item);
            break;
        case 'manage-addons':
            openAddonManagementModal(item);
            break;
        case 'delete-item':
            if(confirm(`Tem certeza que deseja deletar o item "${item.name}"?`)){
                DATA.items = DATA.items.filter(i => i.id !== itemId);
                saveMenuData();
                renderItems();
            }
            break;
    }
}


function addItemToCart(item, qty, addons){
    const cartItem = {
        itemId: item.id,
        name: item.name,
        price: item.price,
        qty: qty,
        addons: addons,
        totalPrice: 0 // Será calculado abaixo
    };
    
    let totalAddons = 0;
    
    addons.forEach(group => {
        group.selected.forEach(addon => {
            const originalGroup = item.addonGroups.find(g => g.id === group.groupId);
            const originalAddon = originalGroup.addons.find(a => a.id === addon.addonId);
            totalAddons += (originalAddon.price * addon.qty);
        });
    });
    
    cartItem.totalPrice = (item.price + totalAddons) * qty;
    
    cart.push(cartItem);
    saveCart();
    renderCart();
    closeModal();
    
    // Se estiver em mobile (<1024px), mostra o carrinho
    if(window.innerWidth <= 1024){
        $("#cartPanel").style.display = 'block'; 
        // Em um app real, aqui o JS faria a transição do carrinho
    }
}

function renderCart(){
    const list = $("#cartList");
    list.innerHTML = '';
    
    let subtotal = 0;
    
    if(cart.length === 0){
        list.innerHTML = '<div class="small" style="color:var(--muted); text-align:center;">Seu carrinho está vazio.</div>';
        $("#btnCheckout").setAttribute('disabled', 'true');
        $("#btnViewCart").classList.remove('active');
        $("#btnViewCart").textContent = `Ver Carrinho (0)`;
    } else {
        $("#btnCheckout").removeAttribute('disabled');
        $("#btnViewCart").classList.add('active');
    }
    
    cart.forEach((item, index) => {
        subtotal += item.totalPrice;
        
        const itemEl = document.createElement('div');
        itemEl.style.cssText = 'border-bottom: 1px solid #eee; padding: 8px 0;';
        
        const mainLine = document.createElement('div');
        mainLine.style.cssText = 'display:flex; justify-content:space-between; align-items:center;';
        mainLine.innerHTML = `
            <div>
                <strong style="font-size:14px;">${item.name}</strong> 
                <span class="small" style="color:var(--muted)">(${formatBRL(item.price)} cada)</span>
            </div>
            <div style="font-weight:700;">${formatBRL(item.totalPrice)}</div>
        `;
        itemEl.appendChild(mainLine);
        
        // Quantidade e Ações
        const qtyActions = document.createElement('div');
        qtyActions.style.cssText = 'display:flex; justify-content:space-between; align-items:center; margin-top:4px;';
        qtyActions.innerHTML = `
            <div class="small" style="color:var(--muted);">Qtd: ${item.qty}</div>
            <button class="pill" data-index="${index}" data-action="remove-item" style="padding: 4px 8px; background:#fbe6e6; color:#dc3545;">Remover</button>
        `;
        itemEl.appendChild(qtyActions);
        
        // Adicionais
        if(item.addons && item.addons.length > 0){
            item.addons.forEach(group => {
                group.selected.forEach(addon => {
                    // Obtém os dados originais do item para o nome
                    const originalItem = getItem(item.itemId);
                    const originalGroup = originalItem.addonGroups.find(g => g.id === group.groupId);
                    const originalAddon = originalGroup.addons.find(a => a.id === addon.addonId);
                    
                    if (addon.qty > 0) {
                        const addonLine = document.createElement('div');
                        addonLine.classList.add('small');
                        addonLine.style.cssText = 'color:var(--muted); margin-left: 10px; border-top: 1px dotted #f5f5f5; padding-top: 2px;';
                        addonLine.textContent = `+ ${addon.qty}x ${originalAddon.name} ${originalAddon.price > 0 ? '(' + formatBRL(originalAddon.price) + ')' : ''}`;
                        itemEl.appendChild(addonLine);
                    }
                });
            });
        }
        
        list.appendChild(itemEl);
    });
    
    $("#subtotal").textContent = formatBRL(subtotal);
    $("#btnViewCart").textContent = `Ver Carrinho (${cart.length})`;

    list.querySelectorAll('[data-action="remove-item"]').forEach(btn => {
        btn.addEventListener('click', (e) => removeItemFromCart(e.target.dataset.index));
    });
}

function removeItemFromCart(index){
    cart.splice(index, 1);
    saveCart();
    renderCart();
    
    // Se o carrinho estiver vazio em mobile, esconde o painel do carrinho
    if(cart.length === 0 && window.innerWidth <= 1024){
        $("#cartPanel").style.display = 'none';
    }
}


function openModal(item){
    modalState = { item: item, qty: 1, addons: generateAddonState(item.addonGroups) };
    
    $("#modalTitle").textContent = "Personalizar " + item.name;
    $("#modalItemName").textContent = item.name;
    $("#modalItemQty").textContent = modalState.qty;
    
    renderModalAddons();
    calculateModalTotal();
    
    $("#modal").classList.add('open');
}

function closeModal(){
    $("#modal").classList.remove('open');
    modalState = null;
}

function generateAddonState(groups){
    return groups.map(group => ({
        groupId: group.id,
        selected: group.addons.map(addon => ({ addonId: addon.id, qty: 0 }))
    }));
}

function renderModalAddons(){
    const addonsEl = $("#modalAddons");
    addonsEl.innerHTML = '';
    
    modalState.item.addonGroups.forEach(group => {
        const groupState = modalState.addons.find(g => g.groupId === group.id);
        const currentCount = groupState.selected.reduce((sum, addon) => sum + addon.qty, 0);
        
        const groupEl = document.createElement('div');
        groupEl.classList.add('addon-group');
        groupEl.innerHTML = `
            <div class="addon-header">
                <strong style="font-size:15px;">${group.name}</strong>
                <div class="small" style="color:var(--muted);">${group.required ? '(Obrigatório)' : `(Max ${group.max}, ${group.free > 0 ? group.free + ' grátis' : 'todos pagos'})`}</div>
            </div>
        `;
        
        group.addons.forEach(addon => {
            const addonState = groupState.selected.find(a => a.addonId === addon.id);
            const addonEl = document.createElement('div');
            addonEl.classList.add('addon-row');
            
            addonEl.innerHTML = `
                <div>
                    ${addon.name} 
                    ${addon.price > 0 ? `<span style="font-weight:600; color:var(--primary);"> (+${formatBRL(addon.price)})</span>` : ''}
                </div>
                <div class="addon-controls">
                    <button data-group="${group.id}" data-addon="${addon.id}" data-action="decrement" ${addonState.qty === 0 ? 'disabled' : ''}>-</button>
                    <span class="count">${addonState.qty}</span>
                    <button data-group="${group.id}" data-addon="${addon.id}" data-action="increment" ${currentCount >= group.max && addonState.qty === 0 ? 'disabled' : ''}>+</button>
                </div>
            `;
            groupEl.appendChild(addonEl);
        });
        
        addonsEl.appendChild(groupEl);
    });
    
    addonsEl.querySelectorAll('.addon-controls button').forEach(btn => {
        btn.addEventListener('click', (e) => handleAddonChange(
            e.target.dataset.group, 
            e.target.dataset.addon, 
            e.target.dataset.action
        ));
    });
}

function handleAddonChange(groupId, addonId, action){
    const group = modalState.item.addonGroups.find(g => g.id === groupId);
    const groupState = modalState.addons.find(g => g.groupId === groupId);
    const addonState = groupState.selected.find(a => a.addonId === addonId);
    
    let currentCount = groupState.selected.reduce((sum, addon) => sum + addon.qty, 0);
    
    if(action === 'increment'){
        if(currentCount < group.max){
            addonState.qty += 1;
        }
    } else if(action === 'decrement'){
        if(addonState.qty > 0){
            addonState.qty -= 1;
        }
    }
    
    renderModalAddons();
    calculateModalTotal();
}

function calculateModalTotal(){
    let basePrice = modalState.item.price;
    let totalAddonsPrice = 0;
    
    modalState.addons.forEach(groupState => {
        const originalGroup = modalState.item.addonGroups.find(g => g.id === groupState.groupId);
        let currentCount = 0;
        
        groupState.selected.forEach(addonState => {
            currentCount += addonState.qty;
            const originalAddon = originalGroup.addons.find(a => a.id === addonState.addonId);
            
            // Lógica de grátis
            let paidQty = addonState.qty;
            if(originalGroup.free > 0){
                const groupTotal = groupState.selected.reduce((sum, a) => sum + a.qty, 0);
                const freeToApply = Math.min(groupTotal, originalGroup.free);
                
                // Distribui o "grátis" de forma simples (pode ser ajustado)
                // A forma mais simples é aplicar o free até o limite e depois cobrar.
                // Aqui, vou manter a lógica de que o preço do adicional é cobrado *sempre* se for > 0, 
                // e o "grátis" é apenas um indicador de limite/info para o usuário.
                // Para uma lógica de desconto real, o JS seria mais complexo. 
                // Mantenho a implementação mais simples (todos os adicionais pagos contam para o total)
                
                // Assumindo que o `free` é apenas um limite visual ou simplificado:
                totalAddonsPrice += (originalAddon.price * addonState.qty);
            } else {
                 totalAddonsPrice += (originalAddon.price * addonState.qty);
            }
        });
    });
    
    let itemTotal = (basePrice + totalAddonsPrice) * modalState.qty;
    $("#modalTotal").textContent = formatBRL(itemTotal);
    
    // Validação de grupos obrigatórios
    let canConfirm = true;
    modalState.item.addonGroups.forEach(group => {
        if(group.required){
            const groupState = modalState.addons.find(g => g.groupId === group.id);
            const currentCount = groupState.selected.reduce((sum, addon) => sum + addon.qty, 0);
            if(currentCount === 0){
                canConfirm = false;
            }
        }
    });
    
    if(canConfirm){
        $("#modalConfirm").removeAttribute('disabled');
        $("#modalConfirm").textContent = `Adicionar ${formatBRL(itemTotal)}`;
    } else {
        $("#modalConfirm").setAttribute('disabled', 'true');
        $("#modalConfirm").textContent = `Faltam opções obrigatórias`;
    }
}

function handleQtyChange(action){
    if(action === 'increment-qty'){
        modalState.qty += 1;
    } else if(action === 'decrement-qty'){
        if(modalState.qty > 1) modalState.qty -= 1;
    }
    $("#modalItemQty").textContent = modalState.qty;
    calculateModalTotal();
}


// === ADMIN MODALS ===

// --- Item Details Modal (CRUD item) ---

function openItemDetailsModal(item = null){
    itemState = item ? { ...item } : { id: Date.now().toString(), category: activeCat || DATA.categories[0].id, name: '', desc: '', price: 0.00, img: blankSVG(), addonGroups: [] };
    
    $("#itemDetailsModalTitle").textContent = item ? "Editar Item: " + item.name : "Adicionar Novo Item";
    $("#itemIdDetails").value = itemState.id;
    $("#itemName").value = itemState.name;
    $("#itemDesc").value = itemState.desc;
    $("#itemPrice").value = itemState.price;
    
    // Preencher categorias
    const catSelect = $("#itemCategory");
    catSelect.innerHTML = '';
    DATA.categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat.id;
        opt.textContent = cat.title;
        if(cat.id === itemState.category) opt.selected = true;
        catSelect.appendChild(opt);
    });
    
    $("#itemDetailsModal").classList.add('open');
}

function closeItemDetailsModal(){
    $("#itemDetailsModal").classList.remove('open');
    itemState = null;
    $("#itemDetailsForm").reset();
}

function saveItemDetails(e){
    e.preventDefault();
    if (!isAdmin) return;
    
    const isNew = !DATA.items.find(i => i.id === itemState.id);
    
    itemState.name = $("#itemName").value;
    itemState.desc = $("#itemDesc").value;
    itemState.price = parseFloat($("#itemPrice").value);
    itemState.category = $("#itemCategory").value;
    
    if(isNew){
        DATA.items.push(itemState);
    } else {
        // Encontra o índice e substitui
        const index = DATA.items.findIndex(i => i.id === itemState.id);
        if(index !== -1){
            // Mantém os grupos de adicionais e imagem existentes se não estiverem sendo editados em outra modal
            DATA.items[index] = { ...DATA.items[index], ...itemState };
        }
    }
    
    saveMenuData();
    renderItems();
    closeItemDetailsModal();
}

// --- Image Edit Modal ---

function openImageEditModal(item){
  itemState = item;
  $("#imageEditModalTitle").textContent = "Editar Imagem para: ";
  $("#imageItemName").textContent = item.name;
  $("#itemIdImage").value = item.id;
  $("#currentImagePreview").src = item.img || blankSVG();
  $("#itemImgUrl").value = item.img || "";
  
  $("#imageEditModal").classList.add('open');
}

function closeImageEditModal(){
  $("#imageEditModal").classList.remove('open');
  itemState = null;
  $("#imageEditForm").reset();
}

async function saveImageEdit(e){
  e.preventDefault();
  if (!isAdmin) return;
  
  const fileInput = $("#itemImgFile");
  let newImgUrl = itemState.img || blankSVG();

  if (fileInput.files.length > 0) {
      try {
          // Converte a imagem para Base64 para salvar no banco de dados
          newImgUrl = await fileToBase64(fileInput.files[0]);
      } catch (error) {
          alert("Erro ao ler o arquivo de imagem.");
          return;
      }
  }
  
  const index = DATA.items.findIndex(i => i.id === itemState.id);
  if(index !== -1){
      DATA.items[index].img = newImgUrl;
      saveMenuData();
      renderItems();
      // Atualiza a prévia da imagem se o modal for reaberto
  }
  
  closeImageEditModal();
}

// --- Addon Management Modal ---

function openAddonManagementModal(item){
    addonManagerState = item;
    $("#addonManagementTitle").textContent = "Gerenciar Adicionais para ";
    $("#addonItemName").textContent = item.name;
    
    renderAddonGroups();
    
    $("#addonManagementModal").classList.add('open');
}

function closeAddonManagementModal(){
    $("#addonManagementModal").classList.remove('open');
    addonManagerState = null;
}

function renderAddonGroups(){
    const list = $("#addonGroupsList");
    list.innerHTML = '';
    
    if (!addonManagerState || addonManagerState.addonGroups.length === 0) {
        list.innerHTML = '<div class="item-management-note">Este item ainda não possui grupos de adicionais. Clique em "+ Adicionar Grupo".</div>';
    }
    
    addonManagerState.addonGroups.forEach((group, groupIndex) => {
        const groupEl = document.createElement('div');
        groupEl.classList.add('addon-group-settings');
        groupEl.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px;">
                <input type="text" value="${group.name}" placeholder="Nome do Grupo (ex: Escolha o Molho)" 
                       onchange="updateAddonGroupProp('${group.id}', 'name', this.value)" style="flex:1; margin-right: 10px; font-weight: 600;">
                <button type="button" class="pill" style="background:#dc3545; color:white; padding:4px 8px;" onclick="removeAddonGroup('${group.id}')">Remover Grupo</button>
            </div>
            
            <div class="meta-addon-info">
                <strong>Configurações:</strong>
                <label style="margin-right:15px;">Max: <input type="number" value="${group.max}" min="1" style="width:50px; padding:4px; display:inline;" 
                       onchange="updateAddonGroupProp('${group.id}', 'max', parseInt(this.value))"></label>
                <label style="margin-right:15px;">Grátis: <input type="number" value="${group.free}" min="0" style="width:50px; padding:4px; display:inline;" 
                       onchange="updateAddonGroupProp('${group.id}', 'free', parseInt(this.value))"></label>
                <label>Obrigatório: <input type="checkbox" ${group.required ? 'checked' : ''} 
                       onchange="updateAddonGroupProp('${group.id}', 'required', this.checked)"></label>
            </div>
            
            <h5 style="margin-top:15px; margin-bottom: 8px;">Itens do Grupo:</h5>
            <div id="addonItemsList-${group.id}">
                ${group.addons.map(addon => `
                    <div class="addon-item-row">
                        <input type="text" value="${addon.name}" placeholder="Nome do Adicional" onchange="updateAddonItemProp('${group.id}', '${addon.id}', 'name', this.value)">
                        <input type="number" value="${addon.price}" step="0.01" placeholder="Preço" style="max-width:80px;" onchange="updateAddonItemProp('${group.id}', '${addon.id}', 'price', parseFloat(this.value))">
                        <button type="button" class="pill" style="background:#dc3545; color:white; padding:4px 8px;" onclick="removeAddonItem('${group.id}', '${addon.id}')">X</button>
                    </div>
                `).join('')}
            </div>
            <button type="button" class="pill" style="background:#e6ffe6; color:#28a745; margin-top:10px; border: 1px dashed #28a745;" onclick="addAddonItem('${group.id}')">+ Adicionar Opção</button>
        `;
        list.appendChild(groupEl);
    });
}

function addAddonGroup() {
    if (!addonManagerState) return;
    const newGroup = {
        id: Date.now().toString(),
        name: "Novo Grupo de Adicionais",
        max: 1,
        free: 0,
        required: false,
        addons: [
            { id: Date.now().toString() + 'a', name: 'Opção Padrão', price: 0.00 }
        ]
    };
    addonManagerState.addonGroups.push(newGroup);
    renderAddonGroups();
}

function removeAddonGroup(groupId) {
    if (!addonManagerState || !confirm("Tem certeza que deseja remover este grupo de adicionais?")) return;
    addonManagerState.addonGroups = addonManagerState.addonGroups.filter(g => g.id !== groupId);
    renderAddonGroups();
}

function updateAddonGroupProp(groupId, prop, value) {
    const group = addonManagerState.addonGroups.find(g => g.id === groupId);
    if (group) {
        group[prop] = value;
        // Não precisa re-renderizar, mas é bom para garantir o estado
        // renderAddonGroups(); 
    }
}

function addAddonItem(groupId) {
    const group = addonManagerState.addonGroups.find(g => g.id === groupId);
    if (group) {
        group.addons.push({ id: Date.now().toString(), name: 'Nova Opção', price: 0.00 });
        renderAddonGroups();
    }
}

function removeAddonItem(groupId, addonId) {
    const group = addonManagerState.addonGroups.find(g => g.id === groupId);
    if (group && confirm("Tem certeza que deseja remover este adicional?")) {
        group.addons = group.addons.filter(a => a.id !== addonId);
        renderAddonGroups();
    }
}

function updateAddonItemProp(groupId, addonId, prop, value) {
    const group = addonManagerState.addonGroups.find(g => g.id === groupId);
    const addon = group ? group.addons.find(a => a.id === addonId) : null;
    if (addon) {
        addon[prop] = value;
        // renderAddonGroups(); // Não precisa re-renderizar
    }
}

function saveAddonManagement(){
    if (!isAdmin || !addonManagerState) return;
    
    // Encontra o item no array principal e atualiza os grupos de adicionais
    const index = DATA.items.findIndex(i => i.id === addonManagerState.id);
    if(index !== -1){
        DATA.items[index].addonGroups = addonManagerState.addonGroups;
        saveMenuData();
        renderItems();
    }
    closeAddonManagementModal();
}

// --- Admin Panel Modal ---

function openAdminModal(tabId = 'orders'){
    if (!isAdmin) return;
    
    // Renderiza a tab correta
    showAdminTab(tabId);
    
    // Se for settings, carrega os dados atuais
    if (tabId === 'settings') {
        loadStoreSettings();
        renderDeliveryAreas();
    }
    
    $("#adminModal").classList.add('open');
}

function closeAdminModal(){
    $("#adminModal").classList.remove('open');
}

function showAdminTab(tabId){
    // Esconde todos os painéis e remove a classe 'active' dos botões
    document.querySelectorAll('.admin-panel').forEach(panel => panel.classList.add('hidden'));
    document.querySelectorAll('.admin-tabs button').forEach(btn => btn.classList.remove('active'));
    
    // Mostra o painel desejado e ativa o botão
    $(`#${tabId}Panel`).classList.remove('hidden');
    $(`#tab${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`).classList.add('active');

    if (tabId === 'orders') {
        renderAdminOrders();
    } else if (tabId === 'sales') {
        renderAdminDashboard();
    } else if (tabId === 'customers') {
        renderAdminCustomers();
    }
}


function renderAdminOrders() {
  const list = $("#currentOrdersList");
  list.innerHTML = '';
  
  if (orders.length === 0) {
    list.innerHTML = '<div class="item-management-note" style="border-left: 4px solid #17a2b8;">Nenhum pedido encontrado.</div>';
    return;
  }
  
  orders.forEach(order => {
    const statusInfo = ORDER_STATUSES[order.status] || ORDER_STATUSES.pending;
    
    const div = document.createElement('div');
    div.style.cssText = `border: 1px solid #eee; border-radius: 8px; padding: 12px; margin-bottom: 10px; background:${order.status === 'pending' ? '#fff7e6' : '#fff'};`;
    div.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong style="font-size:16px;">Pedido #${order.id.substring(0, 7)}</strong>
            <div style="font-size:12px; color:var(--muted);">${new Date(order.createdAt).toLocaleTimeString()}</div>
        </div>
        
        <div class="small" style="color:var(--muted); margin: 4px 0;">
            Cliente: ${order.userName} (${order.userPhone})
        </div>
        
        <div style="margin: 8px 0;">
            <strong style="color:var(--primary); font-size:18px;">Total: ${formatBRL(order.total)}</strong> 
            <span class="small" style="color:var(--muted); margin-left:10px;">(${order.paymentMethod === 'cash' ? 'Dinheiro' + (order.changeNeeded > 0 ? ' c/ Troco para ' + formatBRL(order.changeNeeded) : '') : order.paymentMethod === 'credit' ? 'Crédito' : 'Débito'})</span>
        </div>
        
        <div style="font-size:14px; margin-bottom: 10px;">
            ${order.items.map(item => `
                <div style="margin-left: 10px; margin-top: 4px; border-left: 2px solid #eee; padding-left: 6px;">
                    ${item.qty}x ${item.name} (${formatBRL(item.totalPrice / item.qty)} cada)
                    ${item.addons && item.addons.length > 0 ? `
                        <div class="small" style="color:var(--muted); margin-left: 5px;">
                            + ${item.addons.map(a => `${a.qty}x ${a.name}`).join(', ')}
                        </div>
                    ` : ''}
                </div>
            `).join('')}
        </div>

        <div class="form-group" style="margin-bottom: 0;">
            <label for="status-${order.id}" class="small" style="margin-bottom: 4px;">Atualizar Status (Atual: <span style="font-weight:700; color:${statusInfo.color};">${statusInfo.label}</span>):</label>
            <select id="status-${order.id}" onchange="updateOrderStatus('${order.id}', this.value)">
                ${Object.entries(ORDER_STATUSES).map(([key, info]) => `
                    <option value="${key}" ${order.status === key ? 'selected' : ''} style="color:${info.color};">${info.label}</option>
                `).join('')}
            </select>
        </div>
    `;
    list.appendChild(div);
  });
}

function renderAdminDashboard() {
  if (!salesChartInstance) {
    const ctx = $("#salesChart").getContext('2d');
    salesChartInstance = new Chart(ctx, {
      type: 'bar', // Pode ser 'line', 'bar', 'pie', etc.
      data: {
        labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'],
        datasets: [{
          label: 'Vendas da Semana (R$)',
          data: [1200, 1900, 300, 500, 2000, 3000, 1000], // Dados de Exemplo
          backgroundColor: 'rgba(128, 0, 128, 0.6)',
          borderColor: 'rgba(128, 0, 128, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false, // Permite que o gráfico preencha o contêiner
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  } else {
    // Em uma aplicação real, aqui os dados seriam atualizados
    salesChartInstance.update();
  }
}

function renderAdminCustomers() {
  const list = $("#customersList");
  list.innerHTML = '';
  
  if (users.length === 0) {
    list.innerHTML = '<div class="item-management-note" style="border-left: 4px solid #17a2b8;">Nenhum cliente cadastrado localmente.</div>';
    return;
  }
  
  // Cria uma lista simples de clientes (dados locais para a demo)
  users.forEach(user => {
    const div = document.createElement('div');
    div.style.cssText = 'border: 1px solid #eee; border-radius: 6px; padding: 10px; margin-bottom: 8px;';
    div.innerHTML = `
      <div style="font-weight: 600;">${user.name}</div>
      <div class="small" style="color:var(--muted);">Email: ${user.email} • Tel: ${user.phone || 'N/A'}</div>
    `;
    list.appendChild(div);
  });
}

// --- Store Settings ---

function loadStoreSettings() {
    $("#restaurantName").value = DATA.restaurant.name;
    $("#restaurantAddress").value = DATA.restaurant.address;
    $("#restaurantStatus").value = DATA.restaurant.status;
    $("#currentLogoPreview").src = DATA.restaurant.logo || blankSVG();
    $("#restaurantLogoUrl").value = DATA.restaurant.logo || "";
}

async function saveStoreSettings(e) {
    e.preventDefault();
    if (!isAdmin) return;

    const fileInput = $("#restaurantLogoFile");
    let newLogoUrl = DATA.restaurant.logo || blankSVG();

    if (fileInput.files.length > 0) {
        try {
            newLogoUrl = await fileToBase64(fileInput.files[0]);
        } catch (error) {
            alert("Erro ao ler o arquivo de logo.");
            return;
        }
    }

    DATA.restaurant.name = $("#restaurantName").value;
    DATA.restaurant.address = $("#restaurantAddress").value;
    DATA.restaurant.status = $("#restaurantStatus").value;
    DATA.restaurant.logo = newLogoUrl;
    
    // O deliveryAreas já foi atualizado via onchange/onclick

    await saveMenuData();
    renderAll(); // Atualiza a header
    alert("Configurações da loja salvas com sucesso!");
    // Não fecha o modal para permitir mais edições
}

function renderDeliveryAreas() {
  const list = $("#deliveryAreasList");
  list.innerHTML = '';
  
  if (DATA.restaurant.deliveryAreas.length === 0) {
    list.innerHTML = '<div class="item-management-note">Nenhuma área de entrega cadastrada. Os clientes não conseguirão finalizar o pedido sem uma taxa.</div>';
    return;
  }
  
  DATA.restaurant.deliveryAreas.forEach((area, index) => {
    const div = document.createElement('div');
    div.classList.add('delivery-area-row');
    div.innerHTML = `
      <input type="text" value="${area.name}" placeholder="Nome da Área (ex: Bairro X)" class="area-name-input" 
             onchange="updateDeliveryAreaProp('${area.id}', 'name', this.value)">
      <input type="number" value="${area.fee}" step="0.01" placeholder="Taxa (R$)" class="area-fee-input" 
             onchange="updateDeliveryAreaProp('${area.id}', 'fee', parseFloat(this.value))">
      <button type="button" class="pill" style="background:#dc3545; color:white; padding:4px 8px;" onclick="removeDeliveryArea('${area.id}')">Remover</button>
    `;
    list.appendChild(div);
  });

  // Atualiza o seletor de checkout
  renderCheckoutDeliveryAreas();
}

function addDeliveryArea() {
  if (!isAdmin) return;
  const newArea = {
    id: Date.now().toString(),
    name: "Nova Área",
    fee: 0.00
  };
  DATA.restaurant.deliveryAreas.push(newArea);
  renderDeliveryAreas();
}

function removeDeliveryArea(areaId) {
  if (!isAdmin || !confirm("Tem certeza que deseja remover esta área de entrega?")) return;
  DATA.restaurant.deliveryAreas = DATA.restaurant.deliveryAreas.filter(a => a.id !== areaId);
  renderDeliveryAreas();
}

function updateDeliveryAreaProp(areaId, prop, value) {
  const area = DATA.restaurant.deliveryAreas.find(a => a.id === areaId);
  if (area) {
    area[prop] = value;
    // O saveMenuData será chamado no saveStoreSettings
  }
}

// --- Checkout Modal ---

function openCheckoutModal(){
    if (cart.length === 0) {
        alert("Seu carrinho está vazio!");
        return;
    }
    if (!currentUser) {
        alert("Por favor, faça login ou cadastre-se para finalizar o pedido.");
        openAuthModal();
        return;
    }

    // Preenche os campos do usuário
    $("#checkoutName").value = currentUser.name;
    $("#checkoutPhone").value = currentUser.phone || '';
    
    renderCheckoutCartSummary();
    renderCheckoutDeliveryAreas();
    renderCheckoutSavedAddresses();
    
    // Tenta preencher o endereço com o primeiro salvo se houver
    if (currentUser.savedAddresses && currentUser.savedAddresses.length > 0) {
      $("#checkoutAddress").value = currentUser.savedAddresses[0];
      $("#checkoutSavedAddresses").value = currentUser.savedAddresses[0];
    } else {
      $("#checkoutAddress").value = '';
    }
    
    // Recalcula o total (inicialmente com 0 de taxa)
    updateCheckoutTotal(0, "N/A");

    $("#checkoutModal").classList.add('open');
}

function closeCheckoutModal(){
    $("#checkoutModal").classList.remove('open');
    $("#checkoutForm").reset();
}

function renderCheckoutCartSummary() {
    const summary = $("#checkoutCartSummary");
    summary.innerHTML = '';
    
    cart.forEach(item => {
        const div = document.createElement('div');
        div.style.cssText = 'font-size:13px; margin-bottom: 4px; border-bottom: 1px dotted #eee; padding-bottom: 4px;';
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <span>${item.qty}x ${item.name}</span>
                <span>${formatBRL(item.totalPrice)}</span>
            </div>
        `;
        // Adicionais
        if(item.addons && item.addons.length > 0){
             item.addons.forEach(group => {
                group.selected.forEach(addon => {
                    const originalItem = getItem(item.itemId);
                    const originalGroup = originalItem.addonGroups.find(g => g.id === addon.groupId);
                    const originalAddon = originalGroup.addons.find(a => a.id === addon.addonId);
                    
                    if (addon.qty > 0) {
                        const addonLine = document.createElement('div');
                        addonLine.classList.add('small');
                        addonLine.style.cssText = 'color:var(--muted); margin-left: 15px;';
                        addonLine.textContent = `+ ${addon.qty}x ${originalAddon.name}`;
                        div.appendChild(addonLine);
                    }
                });
            });
        }
        summary.appendChild(div);
    });
}

function renderCheckoutDeliveryAreas() {
    const select = $("#deliveryAreaSelect");
    select.innerHTML = '<option value="" disabled selected>Selecione sua área...</option>';
    
    DATA.restaurant.deliveryAreas.forEach(area => {
        const opt = document.createElement('option');
        opt.value = area.id;
        opt.dataset.fee = area.fee;
        opt.textContent = `${area.name} (${formatBRL(area.fee)})`;
        select.appendChild(opt);
    });
}

function renderCheckoutSavedAddresses() {
  const select = $("#checkoutSavedAddresses");
  select.innerHTML = '<option value="" disabled selected>Selecione um endereço salvo...</option>';

  if (currentUser && currentUser.savedAddresses && currentUser.savedAddresses.length > 0) {
    $("#checkoutSavedAddressesGroup").style.display = 'block';
    currentUser.savedAddresses.forEach(address => {
      const opt = document.createElement('option');
      opt.value = address;
      opt.textContent = address;
      select.appendChild(opt);
    });
  } else {
    $("#checkoutSavedAddressesGroup").style.display = 'none';
  }
}


function updateCheckoutTotal(deliveryFee, areaName) {
    const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
    const total = subtotal + deliveryFee;
    
    $("#checkoutSubtotal").textContent = formatBRL(subtotal);
    $("#checkoutDeliveryFee").textContent = formatBRL(deliveryFee);
    $("#checkoutAreaName").textContent = areaName;
    $("#checkoutTotal").textContent = formatBRL(total);
    $("#checkoutSubmit").removeAttribute('disabled');
}


// --- Confirmation Modal ---

function showConfirmationModal(order) {
  const summary = $("#confirmationSummaryContent");
  summary.innerHTML = '';
  
  // Resumo dos itens
  order.items.forEach(item => {
    const div = document.createElement('div');
    div.style.cssText = 'font-size:13px; margin-bottom: 4px;';
    div.innerHTML = `
      <div style="display:flex; justify-content:space-between;">
          <span style="font-weight:600;">${item.qty}x ${item.name}</span>
          <span>${formatBRL(item.totalPrice)}</span>
      </div>
      ${item.addons && item.addons.length > 0 ? `
        <div class="small" style="color:var(--muted); margin-left: 10px;">
          + ${item.addons.map(a => `${a.qty}x ${a.name}`).join(', ')}
        </div>
      ` : ''}
    `;
    summary.appendChild(div);
  });

  // Totais
  summary.innerHTML += `
      <div style="border-top:1px solid #eee; margin-top: 8px; padding-top: 8px;">
          <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px;">
            <span>Subtotal:</span>
            <span>${formatBRL(order.subtotal)}</span>
          </div>
          <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px;">
            <span>Taxa de Entrega (${order.deliveryAreaName}):</span>
            <span>${formatBRL(order.deliveryFee)}</span>
          </div>
          <div style="display:flex; justify-content:space-between; font-size:16px; font-weight:800; color:var(--primary);">
            <span>TOTAL GERAL:</span>
            <span>${formatBRL(order.total)}</span>
          </div>
      </div>
  `;
  
  $("#orderNumberDisplay").textContent = `#${order.id.substring(0, 7).toUpperCase()}`;
  $("#confirmationModal").classList.add('open');
}

function closeConfirmationModal(){
    $("#confirmationModal").classList.remove('open');
}


// =========================================================================
// === LISTENERS ===
// =========================================================================

function initListeners(){
  // --- Modals de Checkout/Adicionais ---
  $("#modalCancel").addEventListener("click", closeModal);
  $("#modalConfirm").addEventListener("click", () => {
      if (!$("#modalConfirm").disabled) {
          addItemToCart(modalState.item, modalState.qty, modalState.addons);
      }
  });
  
  $("#itemQtyControls").addEventListener("click", (e) => {
      if(e.target.dataset.action){
          handleQtyChange(e.target.dataset.action);
      }
  });
  
  $("#btnCheckout").addEventListener("click", openCheckoutModal);
  $("#checkoutCancel").addEventListener("click", closeCheckoutModal);
  $("#checkoutForm").addEventListener("submit", finalizeOrder);
  
  // Lógica para mostrar o campo de troco
  document.querySelectorAll('input[name="paymentMethod"]').forEach(input => {
    input.addEventListener('change', (e) => {
        if (e.target.value === 'cash') {
            $("#cashChangeGroup").style.display = 'block';
        } else {
            $("#cashChangeGroup").style.display = 'none';
            $("#cashChange").value = ''; // Limpa o valor do troco
        }
    });
  });

  // Lógica para atualizar o total ao selecionar a área de entrega
  $("#deliveryAreaSelect").addEventListener('change', (e) => {
    const selectedOption = e.target.options[e.target.selectedIndex];
    if (selectedOption && selectedOption.dataset.fee) {
        const fee = parseFloat(selectedOption.dataset.fee);
        const name = selectedOption.textContent.split('(')[0].trim();
        updateCheckoutTotal(fee, name);
    }
  });
  
  // Lógica para preencher o endereço no checkout com o salvo
  $("#checkoutSavedAddresses").addEventListener('change', (e) => {
    $("#checkoutAddress").value = e.target.value;
  });

  // --- Modals de Admin ---
  $("#btnAdminPanel").addEventListener("click", () => openAdminModal('orders'));
  $("#tabOrders").addEventListener("click", () => showAdminTab('orders'));
  $("#tabSales").addEventListener("click", () => showAdminTab('sales'));
  $("#tabCustomers").addEventListener("click", () => showAdminTab('customers'));
  $("#tabSettings").addEventListener("click", () => showAdminTab('settings'));
  $("#closeAdminModal").addEventListener("click", closeAdminModal);
  $("#btnReset").addEventListener("click", resetDemo);

  // Formulário de Configurações da Loja
  $("#storeSettingsForm").addEventListener("submit", saveStoreSettings);
  $("#btnAddDeliveryArea").addEventListener("click", addDeliveryArea);

  // Preview do logo
  $("#restaurantLogoFile").addEventListener("change", (e) => {
    if (e.target.files && e.target.files[0]) {
      const reader = new FileReader();
      reader.onload = (r) => {
        $("#currentLogoPreview").src = r.target.result;
      };
      reader.readAsDataURL(e.target.files[0]);
    }
  });
  
  // --- Modals de Item CRUD ---
  $("#itemDetailsForm").addEventListener("submit", saveItemDetails);
  $("#itemDetailsCancel").addEventListener("click", closeItemDetailsModal);
  
  // --- Modals de Imagem ---
  $("#imageEditForm").addEventListener("submit", saveImageEdit);
  $("#imageEditCancel").addEventListener("click", closeImageEditModal);
  $("#itemImgFile").addEventListener("change", (e) => {
    if (e.target.files && e.target.files[0]) {
      const reader = new FileReader();
      reader.onload = (r) => {
        $("#currentImagePreview").src = r.target.result;
      };
      reader.readAsDataURL(e.target.files[0]);
    }
  });
  
  // --- Modals de Adicionais ---
  $("#addonManagementCancel").addEventListener("click", closeAddonManagementModal);
  $("#addonManagementSubmit").addEventListener("click", saveAddonManagement);
  $("#btnAddAddonGroup").addEventListener("click", addAddonGroup);

  // --- Botões de Export/Import ---
  $("#btnExport").addEventListener("click", () => {
    const json = JSON.stringify(DATA, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cardapio_export.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
  
  $("#btnImport").addEventListener("click", () => {
    $("#fileImport").click();
  });
  
  $("#fileImport").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file && confirm("Importar o arquivo JSON irá substituir TODO o cardápio e configurações atuais. Continuar?")) {
      const reader = new FileReader();
      reader.onload = async (event) => {
        try {
          const importedData = JSON.parse(event.target.result);
          DATA = importedData;
          await saveMenuData(); // Salva os dados importados no Firebase
          renderAll();
          alert("Cardápio importado e salvo no Firebase com sucesso!");
        } catch (err) {
          alert("Erro ao processar o arquivo JSON. Verifique o formato.");
          console.error(err);
        }
      };
      reader.readAsText(file);
    }
    // Limpa o input file para permitir importar o mesmo arquivo novamente
    e.target.value = null; 
  });


  // --- Botões de Autenticação/Perfil ---
  $("#userBadge").addEventListener("click", () => {
      if(currentUser){
          openProfileModal();
      } else {
          openAuthModal();
      }
  });
  $("#tabLogin").addEventListener("click", showLoginForm);
  $("#tabRegister").addEventListener("click", showRegisterForm);
  $("#loginCancel").addEventListener("click", closeAuthModal);
  $("#registerCancel").addEventListener("click", closeAuthModal);
  $("#loginSubmit").addEventListener("click", doLogin);
  $("#registerSubmit").addEventListener("click", doRegister);
  $("#logoutBtn").addEventListener("click", () => {
      currentUser = null;
      isAdmin = false;
      closeProfileModal();
      updateUserBadge();
      toggleAdminUI();
      renderItems();
  });
  $("#closeProfile").addEventListener("click", closeProfileModal);
  
  // Adicionar endereço do usuário
  $("#btnAddUserAddress").addEventListener("click", () => {
    if (!currentUser) return;
    const newAddress = $("#newAddressInput").value.trim();
    if (newAddress) {
      if (!currentUser.savedAddresses) currentUser.savedAddresses = [];
      currentUser.savedAddresses.push(newAddress);
      const userToUpdate = users.find(u => u.id === currentUser.id);
      if (userToUpdate) {
        userToUpdate.savedAddresses = currentUser.savedAddresses;
        saveUsers();
        renderProfileAddresses();
        $("#newAddressInput").value = '';
        alert("Endereço salvo!");
      }
    }
  });


  // --- Footer/Carrinho Mobile ---
  $("#btnViewCart").addEventListener("click", () => {
    const cartPanel = $("#cartPanel");
    const isActive = cartPanel.style.display === 'block';

    if(window.innerWidth <= 1024){
      if(isActive){
        cartPanel.style.display = 'none';
      } else if (cart.length > 0) {
        cartPanel.style.display = 'block';
      }
    } else {
        // Para telas maiores, o carrinho já é visível, não faz nada (ou rola para ele)
    }
  });


  // --- Fechar modais ao clicar no overlay ---
  $("#modal").addEventListener("click", (e) => { if(e.target.id === "modal"){ closeModal(); } });
  $("#itemDetailsModal").addEventListener("click", (e) => { if(e.target.id === "itemDetailsModal"){ closeItemDetailsModal(); } });
  $("#addonManagementModal").addEventListener("click", (e) => { if(e.target.id === "addonManagementModal"){ closeAddonManagementModal(); } });
  $("#imageEditModal").addEventListener("click", (e) => { if(e.target.id === "imageEditModal"){ closeImageEditModal(); } });
  $("#authModal").addEventListener("click", (e) => { if(e.target.id === "authModal"){ closeAuthModal(); } });
  $("#profileModal").addEventListener("click", (e) => { if(e.target.id === "profileModal"){ closeProfileModal(); } });
  $("#checkoutModal").addEventListener("click", (e) => { if(e.target.id === "checkoutModal"){ closeCheckoutModal(); } });
  $("#adminModal").addEventListener("click", (e) => { if(e.target.id === "adminModal"){ closeAdminModal(); } });
  $("#confirmationModal").addEventListener("click", (e) => { if(e.target.id === "confirmationModal"){ closeConfirmationModal(); } });
  $("#closeConfirmationModal").addEventListener("click", closeConfirmationModal);
}

// === INICIALIZAÇÃO FINAL ===

document.addEventListener("DOMContentLoaded", () => {
  users = loadUsers(); // Carrega usuários locais (para a demo de login)
  fetchMenuData(); // 👈 Começa buscando dados do Firebase
  initListeners();
});

// =========================================================================
// === EXPOSIÇÃO GLOBAL DE FUNÇÕES (CORREÇÃO DE ONCLICK/ONCHANGE) ===
// Funções chamadas a partir de HTML gerado dinamicamente precisam estar no escopo global (window)
// =========================================================================
window.updateOrderStatus = updateOrderStatus;
window.removeUserAddress = removeUserAddress;
window.addAddonGroup = addAddonGroup;
window.removeAddonGroup = removeAddonGroup;
window.addAddonItem = addAddonItem;
window.removeAddonItem = removeAddonItem;
window.updateAddonGroupProp = updateAddonGroupProp;
window.updateAddonItemProp = updateAddonItemProp;
window.removeDeliveryArea = removeDeliveryArea;
window.editCategory = editCategory;
window.removeCategory = removeCategory;



</script>
</body>
</html>









    <div class="modal" id="itemDetailsModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:500px">
        <h3 id="itemDetailsModalTitle">Adicionar Novo Item</h3>
        <form id="itemDetailsForm">
          <input type="hidden" id="itemIdDetails" />
          <div class="form-group">
            <label for="itemName">Nome do Item</label>
            <input type="text" id="itemName" required>
          </div>
          <div class="form-group">
            <label for="itemDesc">Descrição</label>
            <textarea id="itemDesc" rows="3" required></textarea>
          </div>
          <div class="form-group">
            <label for="itemPrice">Preço (R$)</label>
            <input type="number" id="itemPrice" step="0.01" required>
          </div>
          <div class="form-group">
            <label for="itemCategory">Categoria</label>
            <select id="itemCategory" required></select>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
            <button type="button" id="itemDetailsCancel" class="pill">Cancelar</button>
            <button type="submit" class="btn" id="itemDetailsSubmit">Salvar Detalhes</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal" id="addonManagementModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:800px">
        <h3 id="addonManagementTitle">Gerenciar Adicionais para <span id="addonItemName" style="color:var(--primary);"></span></h3>
        
        <div id="addonGroupsList"></div>
        
        <div style="margin-top:16px; display:flex; justify-content:space-between; align-items:center;">
          <button type="button" class="btn" id="btnAddAddonGroup" style="background:#28a745;">+ Adicionar Grupo</button>
          <div>
            <button type="button" id="addonManagementCancel" class="pill">Cancelar</button>
            <button type="button" class="btn" id="addonManagementSubmit">Salvar Adicionais</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="imageEditModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:500px">
        <h3 id="imageEditModalTitle">Editar Imagem para <span id="imageItemName" style="color:var(--primary);"></span></h3>
        <form id="imageEditForm">
          <input type="hidden" id="itemIdImage" />
          
          <div class="form-group">
            <label for="itemImgFile">Escolher Imagem do Item</label>
            <input type="file" id="itemImgFile" accept="image/*">
            <input type="hidden" id="itemImgUrl"> </div>
          <div style="text-align:center; margin-bottom:16px;">
             <img id="currentImagePreview" src="" alt="Prévia" style="max-width:100%; height:auto; border-radius:8px; margin-top:10px;">
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
            <button type="button" id="imageEditCancel" class="pill">Cancelar</button>
            <button type="submit" class="btn" id="imageEditSubmit">Salvar Imagem</button>
          </div>
        </form>
      </div>
    </div>

